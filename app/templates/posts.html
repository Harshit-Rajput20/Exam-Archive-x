<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Posts</title>
  </head>
  <body>
    <h1>Posts</h1>

    {% if user %}
    <!-- Render logout button -->
    <form action="{{ url_for('posts.submit_post') }}" method="post">
      <textarea name="post_content" rows="4" cols="50"></textarea><br />
      <input type="submit" value="Submit" />
    </form>
    {% endif %}
    <hr />
    <h2>Existing Posts:</h2>
    <ul id="post-container">
      {% for post in posts %}
      <a href="/thread/{{post.thread.ThreadID}}">
        <li>
          <p>UserID: {{ post.UserID }}</p>
          <p>Content: {{ post.Content | safe }}</p>
          <p>time stamp: {{ post.TimeStamp }}</p>
          <p>difficulty: {{ post.DifficultyLevel }}</p>
          <!-- Add other details as needed -->
        </li>
      </a>
      {% endfor %}
    </ul>

    <!-- JavaScript for lazy loading -->
    <script>
      let page = 2; // Initial page for lazy loading
      let loading = false;

      function loadMorePosts() {
        if (!loading) {
          loading = true;
          fetch(`/posts/load-more?page=${page}`)
            .then((response) => response.json())
            .then((data) => {
              const posts = data.posts;
              const hasMore = data.has_next;

              if (posts.length > 0) {
                const postContainer = document.getElementById("post-container");
                posts.forEach((post) => {
                  const postElement = document.createElement("li");
                  postElement.innerHTML = `
                                  <a href="/thread/${post.ThreadID}">
                                      <p>UserID: ${post.UserID}</p>
                                      <p>Content: ${post.Content}</p>
                                      <p>time stamp: ${post.TimeStamp}</p>
                                      <p>difficulty: ${post.DifficultyLevel}</p>
                                      <!-- Add other details as needed -->
                                  </a>
                              `;
                  postContainer.appendChild(postElement);
                });
                if (hasMore) {
                  page++;
                  loading = false; // Reset loading flag
                } else {
                  window.removeEventListener("scroll", handleScroll);
                }
              }
            })
            .catch((error) => {
              console.error("Error loading more posts:", error);
              loading = false; // Reset loading flag
            });
        }
      }

      function handleScroll() {
        if (
          window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 100
        ) {
          loadMorePosts();
        }
      }

      window.addEventListener("scroll", handleScroll);

      // Load more posts initially
      loadMorePosts();
    </script>
  </body>
</html>
